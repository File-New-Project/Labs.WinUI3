name: Nightly Builds

on:
  # schedule:
  #   - cron: '0 15 * * *' # Daily at 3PM UTC / 7AM PST
  workflow_dispatch:
    inputs:
      branch:
        description: 'Target branch'
        required: false
        type: choice
        options:
          - all
          - main
          - nightly-community
        default: 'all'
      platform:
        description: 'Target platform'
        required: false
        type: choice
        options:
          - all
          - x64
          - x86
          - arm64
          - arm64ec
        default: 'all'

env:
  CACHE_DIR: C:\actions-runner-shared\_cache
  SYMBOL_STORE_PATH: C:\Symbols

jobs:
  build:
    runs-on: [self-hosted, windows]
    strategy:
      matrix:
        branch: ${{ (github.event_name == 'workflow_dispatch' && inputs.branch != 'all') && fromJson(format('["{0}"]', inputs.branch)) || fromJson('["main", "nightly-community"]') }}
        platform: ${{ (github.event_name == 'workflow_dispatch' && inputs.platform != 'all') && fromJson(format('["{0}"]', inputs.platform)) || fromJson('["x64", "x86", "arm64", "arm64ec"]') }}
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: '1'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ matrix.branch }}

      - name: Get commit SHA (short)
        id: commit
        run: |
          $sha = git rev-parse --short HEAD
          echo "sha=$sha" >> $env:GITHUB_OUTPUT
        shell: pwsh
      
      - name: Generate version
        id: version
        run: |
          $datetime = (Get-Date).ToString("yyyyMMddHHmmss")
          if ("${{ matrix.branch }}" -eq "nightly-community") {
            $version = "0.0.0-nightlycommunity.$datetime.${{ steps.commit.outputs.sha }}"
          } else {
            $version = "0.0.0-nightly.$datetime.${{ steps.commit.outputs.sha }}"
          }
          echo "version=$version" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Initialize
        run: >
          .\init.cmd ${{ matrix.platform }}fre net8 /pipeline
        shell: cmd
        working-directory: src

      - name: "Temporary: Manually restore missing ARM64 SDK package"
        if: matrix.platform == 'arm64'
        run: nuget install Microsoft.Windows.SDK.cpp.arm64 -Version 10.0.22621.755 -OutputDirectory packages -Source https://api.nuget.org/v3/index.json
        shell: cmd
        working-directory: src

      - name: Restore packages
        run: >
          powershell -ExecutionPolicy Bypass -NoProfile -File %RepoRoot%\scripts\init\Initialize-Restore.ps1 -RepoRoot %RepoRoot%
        shell: cmd
        working-directory: src

      - name: Build
        env:
          CL: /MP2
          BuildPlatform: ${{ matrix.platform }}
        run: >
          .\build.cmd prodtest /c /restore /version ${{ steps.version.outputs.version }}
        shell: cmd
        working-directory: src
      
      - name: Stash packaging artifacts and symbols
        run: |
          $cacheDir = "${{ env.CACHE_DIR }}\nightly-packaging-${{ github.run_id }}-${{ matrix.branch }}-${{ matrix.platform }}"
          New-Item -ItemType Directory -Force -Path $cacheDir
          
          if (Test-Path "BuildOutput\packaging\Release") {
            Copy-Item -Path "BuildOutput\packaging\Release\*" -Destination "$cacheDir\" -Recurse -Force
            Write-Host "Cached ${{ matrix.platform }} packaging to $cacheDir"
          }

          $buildArch = switch ("${{ matrix.platform }}") {
            "x64" { "amd64" }
            "x86" { "x86" }
            "arm64" { "arm64" }
            "arm64ec" { "arm64ec" }
          }
          
          $symbolsPath = "BuildOutput\bin\${buildArch}fre\Symbols\Product"
          if (Test-Path $symbolsPath) {
            $symbolsCacheDir = "$cacheDir\Symbols"
            New-Item -ItemType Directory -Force -Path $symbolsCacheDir
            Copy-Item -Path "$symbolsPath\*" -Destination "$symbolsCacheDir\" -Recurse -Force
            Write-Host "Cached ${{ matrix.platform }} (${buildArch}) symbols to $symbolsCacheDir"
            ls -Recurse $symbolsCacheDir | Select-Object -First 20
          }
          
          Write-Host "`nCache directory contents:"
          ls -Recurse $cacheDir | Select-Object -First 30
        shell: pwsh
        working-directory: src

  package:
    needs: build
    runs-on: [self-hosted, windows]
    strategy:
      matrix:
        branch: ${{ (github.event_name == 'workflow_dispatch' && inputs.branch != 'all') && fromJson(format('["{0}"]', inputs.branch)) || fromJson('["main", "nightly-community"]') }}
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: '1'
      TARGET_FOUNDATION_VERSION: '2.0.8-experimental'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ matrix.branch }}

      - name: Get commit SHA (short)
        id: commit
        run: |
          $sha = git rev-parse --short HEAD
          echo "sha=$sha" >> $env:GITHUB_OUTPUT
        shell: pwsh
      
      - name: Generate version
        id: version
        run: |
          $datetime = (Get-Date).ToString("yyyyMMddHHmmss")
          if ("${{ matrix.branch }}" -eq "nightly-community") {
            $channel = "NightlyCommunity"  
            $version = "0.0.0-nightlycommunity.$datetime.${{ steps.commit.outputs.sha }}"
          } else {
            $channel = "Nightly"
            $version = "0.0.0-nightly.$datetime.${{ steps.commit.outputs.sha }}"
          }
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "channel=$channel" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Restore cached packaging artifacts
        run: |
          $packagingDir = "BuildOutput\packaging\Release"
          New-Item -ItemType Directory -Force -Path $packagingDir
          
          $platforms = if ("${{ github.event_name }}" -eq "workflow_dispatch" -and "${{ inputs.platform }}" -ne "all") {
            @("${{ inputs.platform }}")
          } else {
            @('x64', 'x86', 'arm64', 'arm64ec')
          }
          
          foreach ($platform in $platforms) {
            $cacheDir = "${{ env.CACHE_DIR }}\nightly-packaging-${{ github.run_id }}-${{ matrix.branch }}-$platform"
            if (Test-Path $cacheDir) {
              Write-Host "Overlaying $platform..."
              Copy-Item -Path "$cacheDir\*" -Destination "$packagingDir\" -Recurse -Force -Exclude "Symbols"
            } else {
              Write-Warning "Cache not found for $platform at $cacheDir"
              exit 1
            }
          }
          
          Write-Host "`nFinal packaging directory structure:"
          ls -Recurse $packagingDir | Select-Object -First 50
        shell: pwsh
        working-directory: src

      - name: Restore Foundation package
        run: nuget install Microsoft.WindowsAppSDK.Foundation -Version ${{ env.TARGET_FOUNDATION_VERSION }} -OutputDirectory packages -Source https://api.nuget.org/v3/index.json
        shell: cmd
        working-directory: src

      - name: Build NuGet package
        run: |
          .\build\nuspecs\build-nupkg.cmd -Channel ${{ steps.version.outputs.channel }} -VersionOverride ${{ steps.version.outputs.version }} -Nuspec File-New-Project.Labs.WinUI.nuspec -PackageRoot ..\..\BuildOutput\packaging\Release -UseDependencyOverrides
        shell: cmd
        working-directory: src
      
      - name: Push to GitHub Packages
        run: |
          ls -Recurse src\PackageStore
          dotnet nuget push "src\PackageStore\*.nupkg" --source "https://nuget.pkg.github.com/File-New-Project/index.json" --api-key ${{ secrets.GITHUB_TOKEN }} --skip-duplicate
        shell: pwsh

      - name: Index and publish symbols to symbol store
        run: |
          New-Item -ItemType Directory -Force -Path "${{ env.SYMBOL_STORE_PATH }}"
          
          $debuggingTools = "C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\srcsrv"
          $pdbstr = Join-Path $debuggingTools "pdbstr.exe"
          $srctool = Join-Path $debuggingTools "srctool.exe"
          
          if (-not (Test-Path $pdbstr)) {
            Write-Error "pdbstr.exe not found at $pdbstr"
            exit 1
          }
          if (-not (Test-Path $srctool)) {
            Write-Error "srctool.exe not found at $srctool"
            exit 1
          }
          
          $repoUrl = "https://raw.githubusercontent.com/${{ github.repository }}"
          $commitSha = "$(git rev-parse HEAD)"
          
          Write-Host "Repository: ${{ github.repository }}"
          Write-Host "Commit SHA: $commitSha"
          
          $platforms = if ("${{ github.event_name }}" -eq "workflow_dispatch" -and "${{ inputs.platform }}" -ne "all") {
            @("${{ inputs.platform }}")
          } else {
            @('x64', 'x86', 'arm64', 'arm64ec')
          }
          
          foreach ($platform in $platforms) {
            $symbolsCacheDir = "${{ env.CACHE_DIR }}\nightly-packaging-${{ github.run_id }}-${{ matrix.branch }}-$platform\Symbols"
            
            if (Test-Path $symbolsCacheDir) {
              Write-Host "`nProcessing $platform symbols..."
              
              $pdbFiles = Get-ChildItem -Path $symbolsCacheDir -Filter "*.pdb" -Recurse
              
              Write-Host "Found $($pdbFiles.Count) PDB files for $platform"
              
              foreach ($pdb in $pdbFiles) {
                Write-Host "  Source indexing $($pdb.Name)..."
                $sources = & $srctool -r $pdb.FullName 2>$null | Where-Object { $_ -match '\\' }
                
                if ($sources) {
                  $sampleSource = $sources | Select-Object -First 1
                  $buildRoot = $null
                  
                  if ($sampleSource -match '^([A-Z]:\\.*?\\Labs\.WinUI3\\Labs\.WinUI3\\)') {
                    $buildRoot = $matches[1]
                    Write-Host "    Detected build root: $buildRoot"
                  } else {
                    Write-Warning "    Could not detect build root from: $sampleSource"
                    Write-Warning "    Skipping source indexing for this PDB"
                    continue
                  }
                  
                  $srcSrvContent = "SRCSRV: ini ------------------------------------------------`n"
                  $srcSrvContent += "VERSION=1`n"
                  $srcSrvContent += "VERCTRL=http`n"
                  $srcSrvContent += "SRCSRV: variables ------------------------------------------`n"
                  $srcSrvContent += "SRCSRVTRG=%var2%`n"
                  $srcSrvContent += "SRCSRV: source files ---------------------------------------`n"
                  
                  $indexedCount = 0
                  foreach ($source in $sources) {
                    $relativePath = $source -replace [regex]::Escape($buildRoot), ""
                    $relativePath = $relativePath -replace '\\', '/'
                    $gitHubUrl = "$repoUrl/$commitSha/$relativePath"
                    
                    $srcSrvContent += "$source*$gitHubUrl`n"
                    $indexedCount++
                  }
                  
                  $srcSrvContent += "SRCSRV: end ------------------------------------------------"
                  
                  $tempFile = [System.IO.Path]::GetTempFileName()
                  Set-Content -Path $tempFile -Value $srcSrvContent -Encoding ASCII
                  
                  $result = & $pdbstr -w -p:$($pdb.FullName) -i:$tempFile -s:srcsrv 2>&1
                  
                  Remove-Item $tempFile -Force
                  Write-Host "    Indexed $indexedCount source files"
                } else {
                  Write-Host "    No source files found in PDB"
                }
              }
              
              Write-Host "Publishing $platform symbols to symbol store..."
              & "C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\symstore.exe" add /r /f "$symbolsCacheDir\*" /s "${{ env.SYMBOL_STORE_PATH }}" /t "${{ matrix.branch }}" /v "${{ steps.version.outputs.version }}" /c "Nightly build ${{ matrix.branch }} - $platform - commit $commitSha"
              
              Write-Host "Published $platform symbols"
            } else {
              Write-Warning "No symbols found for $platform at $symbolsCacheDir"
            }
          }
          
          Write-Host "`nSymbol store updated at ${{ env.SYMBOL_STORE_PATH }}"
        shell: pwsh

      - name: Cleanup cache
        if: always()
        run: |
          Remove-Item -Path "${{ env.CACHE_DIR }}\nightly-packaging-${{ github.run_id }}-${{ matrix.branch }}-*" -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "Cleaned up cache for run ${{ github.run_id }}"
        shell: pwsh